<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculatrice Co√ªt Main d'≈íuvre - BTS Com</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #8b5cf6;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --border: #e5e7eb;
            --muted: #6b7280;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 1000px;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header { background-color: #1e1b4b; color: white; padding: 1.5rem; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; }
        
        /* CONTROLS */
        .controls { 
            padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: center; gap: 20px; align-items: center;
        }
        
        .mode-switch {
            display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px;
        }
        .mode-btn {
            padding: 8px 16px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: 600; color: #64748b;
        }
        .mode-btn.active { background: white; color: var(--primary); shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* TABLEAU */
        .table-container { padding: 1rem; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { background-color: #f1f5f9; text-align: left; padding: 12px; font-weight: 600; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }

        input, select {
            width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box;
            font-family: inherit;
        }
        input[type="number"] { text-align: right; font-weight: 600; }
        
        /* Colonne automatique (gris√©e) */
        .auto-calc {
            background-color: #f3f4f6;
            color: var(--muted);
            font-style: italic;
            border: 1px dashed #d1d5db;
            text-align: right;
            padding-right: 10px;
            border-radius: 4px;
            display: block; 
            line-height: 2.2;
        }

        .total-row td { background-color: #f8fafc; font-weight: bold; border-top: 2px solid #cbd5e1; font-size: 1.1rem; }

        /* BOUTONS */
        .btn-delete { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; }
        .btn-delete:hover { color: #ef4444; }
        
        .actions-bar { padding: 1rem; display: flex; justify-content: space-between; background-color: #f8fafc; border-top: 1px solid var(--border); }
        
        button.action-btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s; }
        .btn-add { background-color: var(--primary); color: white; }
        .btn-pdf { background-color: white; border: 1px solid #D32F2F; color: #D32F2F; }
        .btn-pdf:hover { background-color: #D32F2F; color: white; }
        .btn-excel { background-color: white; border: 1px solid #1D6F42; color: #1D6F42; }
        .btn-excel:hover { background-color: #1D6F42; color: white; }

        /* INFO BOX */
        .info-box {
            margin: 15px; padding: 15px; background-color: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px; font-size: 0.9rem; color: #1e40af;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>üë• Calculatrice Main d'≈íuvre</h1>
        <div style="font-size:0.9rem; opacity:0.8; margin-top:5px;">Du Salaire Brut au Co√ªt R√©el (Budget)</div>
    </div>

    <div class="controls">
        <span style="font-weight:bold; font-size:0.9rem;">Unit√© de temps :</span>
        <div class="mode-switch">
            <button class="mode-btn active" id="btn-hour" onclick="setMode('hour')">Heures</button>
            <button class="mode-btn" id="btn-day" onclick="setMode('day')">Jours</button>
        </div>
    </div>

    <div class="info-box" id="info-text">
        üí° <strong>Mode Automatique :</strong> Saisissez le <strong>Salaire Brut</strong> (celui de la fiche de paie). L'outil ajoute automatiquement <strong>+45%</strong> de charges pour estimer le co√ªt r√©el pour l'entreprise.
    </div>

    <div class="table-container">
        <table id="rhTable">
            <thead>
                <tr>
                    <th style="width:25%">Poste</th>
                    <th style="width:18%" id="col-brut">Brut Horaire (‚Ç¨)</th>
                    <th style="width:18%" id="col-loaded">Co√ªt Charg√© (+45%)</th>
                    <th style="width:15%" id="col-time">Heures</th>
                    <th style="width:20%; text-align:right;">Total Budget</th>
                    <th style="width:4%"></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="4" style="text-align:right; padding-right:20px;">TOTAL BUDGET RH ESTIM√â :</td>
                    <td style="text-align:right; color: var(--primary);" id="grandTotal">0,00 ‚Ç¨</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="actions-bar">
        <button class="action-btn btn-add" onclick="addRow()"><span>+</span> Ajouter un poste</button>
        <div style="display:flex; gap:10px;">
            <button class="action-btn btn-excel" onclick="downloadExcel()">üìó Exporter en Excel</button>
            <button class="action-btn btn-pdf" onclick="generatePDF()">üìÑ Exporter en PDF</button>
        </div>
    </div>
</div>

<script>
    let currentMode = 'hour'; // 'hour' ou 'day'
    const LOADED_COEFF = 1.45; // Coefficient multiplicateur (45% de charges)

    document.addEventListener('DOMContentLoaded', () => { addRow(); });

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-hour').className = mode === 'hour' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-day').className = mode === 'day' ? 'mode-btn active' : 'mode-btn';
        
        if (mode === 'hour') {
            document.getElementById('col-brut').innerText = "Brut Horaire (‚Ç¨)";
            document.getElementById('col-loaded').innerText = "Co√ªt Charg√© / h";
            document.getElementById('col-time').innerText = "Heures";
        } else {
            document.getElementById('col-brut').innerText = "Salaire Brut / Jour";
            document.getElementById('col-loaded').innerText = "Co√ªt Charg√© / j";
            document.getElementById('col-time').innerText = "Jours";
        }
        recalculateAll();
    }

    function addRow() {
        const tbody = document.getElementById('tableBody');
        const row = document.createElement('tr');
        
        const roles = `
            <option value="">-- Poste --</option>
            <option value="Chef de Projet">Chef de Projet</option>
            <option value="Directeur Artistique">Directeur Artistique</option>
            <option value="Graphiste">Graphiste</option>
            <option value="Community Manager">Community Manager</option>
            <option value="Concepteur R√©dacteur">Concepteur R√©dacteur</option>
            <option value="Stagiaire">Stagiaire</option>
            <option value="Autre">Autre</option>
        `;

        row.innerHTML = `
            <td><select class="input-role">${roles}</select></td>
            <td><input type="number" class="input-brut" placeholder="0" oninput="calculateRow(this)"></td>
            <td><span class="auto-calc cell-loaded">0,00 ‚Ç¨</span></td>
            <td><input type="number" class="input-time" placeholder="0" oninput="calculateRow(this)"></td>
            <td style="text-align:right; font-weight:bold;" class="cell-total">0,00 ‚Ç¨</td>
            <td style="text-align:center;"><button class="btn-delete" onclick="deleteRow(this)">√ó</button></td>
        `;
        tbody.appendChild(row);
    }

    function deleteRow(btn) {
        const row = btn.parentNode.parentNode;
        if (document.getElementById('tableBody').rows.length > 1) { row.remove(); recalculateAll(); }
        else { 
            row.querySelectorAll('input').forEach(i => i.value = ''); 
            calculateRow(row.querySelector('input')); 
        }
    }

    function calculateRow(inputElement) {
        const row = inputElement.closest('tr');
        const brut = parseFloat(row.querySelector('.input-brut').value) || 0;
        const time = parseFloat(row.querySelector('.input-time').value) || 0;
        
        const loaded = brut * LOADED_COEFF;
        const total = loaded * time;
        
        row.querySelector('.cell-loaded').innerText = loaded.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
        row.querySelector('.cell-total').innerText = total.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
        
        updateGrandTotal();
    }

    function recalculateAll() {
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const input = row.querySelector('.input-brut');
            if(input) calculateRow(input);
        });
    }

    function updateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const brut = parseFloat(row.querySelector('.input-brut').value) || 0;
            const time = parseFloat(row.querySelector('.input-time').value) || 0;
            grandTotal += (brut * LOADED_COEFF * time);
        });
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
    }

    // --- PDF PROPRE ---
    function generatePDF() {
        let rowsHTML = "";
        const unitPrice = currentMode === 'hour' ? '/h' : '/j';
        
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const role = row.querySelector('.input-role').value || "Non d√©fini";
            const brut = (parseFloat(row.querySelector('.input-brut').value) || 0).toLocaleString('fr-FR');
            const loaded = row.querySelector('.cell-loaded').innerText;
            const time = (parseFloat(row.querySelector('.input-time').value) || 0).toLocaleString('fr-FR');
            const total = row.querySelector('.cell-total').innerText;

            rowsHTML += `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px; font-weight:bold;">${role}</td>
                    <td style="padding: 10px; text-align:right; color:#666;">${brut} ‚Ç¨ (Brut)</td>
                    <td style="padding: 10px; text-align:right; font-weight:bold;">${loaded} ${unitPrice}</td>
                    <td style="padding: 10px; text-align:center;">${time}</td>
                    <td style="padding: 10px; text-align:right; font-weight:bold;">${total}</td>
                </tr>
            `;
        });

        const grandTotal = document.getElementById('grandTotal').innerText;

        const content = `
            <div style="padding: 20px; font-family: Arial, sans-serif; color: #000;">
                <h1 style="text-align:center; color:#1e1b4b; margin-bottom: 5px;">Budget Main d'≈íuvre</h1>
                <div style="text-align:center; font-size:12px; color:#666; margin-bottom:30px;">
                    Mode : ${currentMode === 'hour' ? 'Horaire' : 'Journalier'} | Charges : +45% (Automatique)
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size:12px;">
                    <thead>
                        <tr style="background-color:#f3f4f6; border-bottom: 2px solid #000;">
                            <th style="text-align:left; padding:10px;">Poste</th>
                            <th style="text-align:right; padding:10px;">Salaire Brut (Saisi)</th>
                            <th style="text-align:right; padding:10px;">Co√ªt Charg√© (Calcul√©)</th>
                            <th style="text-align:center; padding:10px;">Volume</th>
                            <th style="text-align:right; padding:10px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#f3f4f6; border-top: 2px solid #000;">
                            <td colspan="4" style="text-align:right; padding:15px; font-weight:bold; text-transform:uppercase;">Total Budget :</td>
                            <td style="text-align:right; padding:15px; font-size:16px; font-weight:bold;">${grandTotal}</td>
                        </tr>
                    </tfoot>
                </table>
                 <div style="margin-top:40px; border:1px solid #ccc; padding:15px; font-size:11px; color:#666;">
                    <strong>Note :</strong> Le co√ªt charg√© inclut le salaire brut + 45% de charges patronales estim√©es.
                </div>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = content;
        
        const opt = {
            margin: 0.5,
            filename: 'Budget_RH.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // --- EXCEL ---
    function downloadExcel() {
        let data = [];
        
        // En-t√™tes adapt√©s au mode
        const headerUnit = currentMode === 'hour' ? 'Horaire' : 'Journalier';
        const headerTime = currentMode === 'hour' ? 'Heures' : 'Jours';
        
        data.push([
            "Poste / R√¥le", 
            `Salaire Brut ${headerUnit}`, 
            `Co√ªt Charg√© ${headerUnit} (+45%)`, 
            headerTime, 
            "Total Budget"
        ]);

        document.querySelectorAll('#tableBody tr').forEach(row => {
            let role = row.querySelector('.input-role').value;
            let brut = parseFloat(row.querySelector('.input-brut').value) || 0;
            // On recalcule ici pour √™tre s√ªr d'avoir la valeur num√©rique pour Excel
            let loaded = brut * LOADED_COEFF;
            let time = parseFloat(row.querySelector('.input-time').value) || 0;
            let total = loaded * time;
            
            data.push([role, brut, loaded, time, total]);
        });

        // Ligne Total
        let grandTotalStr = document.getElementById('grandTotal').innerText;
        // Nettoyage de la chaine (enlever ‚Ç¨ et espace ins√©cable) pour Excel si besoin, 
        // ou on laisse vide et l'√©tudiant fera sa somme sur Excel.
        // Ici on met une ligne texte pour le total
        data.push(["", "", "", "TOTAL G√âN√âRAL", parseFloat(grandTotalStr.replace(/\s|‚Ç¨/g, '').replace(',', '.'))]);

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Budget_RH");
        XLSX.writeFile(wb, "Budget_Main_Oeuvre.xlsx");
    }
</script>

</body>
</html>
